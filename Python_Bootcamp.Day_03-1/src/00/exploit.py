from bs4 import BeautifulSoup


def set_new_title(soup, new_title):
    soup.title.string = new_title


def get_initials(soup):
    name_tag = soup.find('span', {'class': 'name'}).__copy__()
    pronoun_tag = name_tag.find('span', {'class': 'pronoun'})
    pronoun_tag.extract()
    return pronoun_tag.string + name_tag.string


def create_new_tag_in_body(soup, tag_name, text):
    new_tag = soup.new_tag(tag_name)
    new_tag.string = text
    body_tag = soup.find('body')
    if body_tag:
        body_tag.append(new_tag)


def update_tag(soup, tag_name, attr_name, attr_text, tag_text):
    tag = soup.find(tag_name)
    if tag:
        tag[attr_name] = attr_text
        tag.string = tag_text


if __name__ == '__main__':
    with open('../materials/evilcorp.html', 'r') as input_file:
        soup = BeautifulSoup(input_file, 'html.parser')
        script = """
            hacked = function() 
            {
                alert('hacked');
            }
            window.addEventListener('load', 
                function() 
                { 
                    var f = document.querySelector("form");
                    f.setAttribute("onsubmit", "hacked()");
                },
                false
            );
        """
        h1 = get_initials(soup) + ', you are hacked!'
        set_new_title(soup, 'Evil Corp - Stealing your money every day')
        create_new_tag_in_body(soup, 'h1', h1)
        create_new_tag_in_body(soup, 'script', script)
        update_tag(soup, 'a', 'href', 'https://mrrobot.fandom.com/wiki/Fsociety', 'Fsociety')

        with open('../materials/evilcorp_hacked.html', 'w', encoding='utf-8') as output_file:
            output_file.write(str(soup))
